---
title: "A Syndromic COVID-19 Indicator Based on Insurance Claims of Outpatient Visits"
author: "Aaron Rumack and Roni Rosenfeld"
date: 2020-10-14
tags: ["nowcasting", "data sources"]
output:
  html_document:
    code_folding: hide
---

In addition to syndicating familiar indicators of COVID-19 activity, like cases and deaths, our COVIDcast map and API feature several novel early indicators. In past posts, we discussed our massive symptom surveys that have reached over 12 million people, in partnership with Facebook and Google. Another of our significant data initiatives has been to forge partnerships with healthcare systems, granting us access to hospital records and insurance claims data covering 10-15% of the United States population.  Our team processes these data, releasing aggregates that can serve as early indicators of COVID activity that may improve epidemiological forecasts and help policymakers make informed decisions. The new data allow us to calculate a signal that estimates levels of symptoms when available. We discuss what the new data reveals over our confirmed cases signal, how we calculate the %CLI signal, why this data appears less useful over time, and how this discovery leads to a simple adjustment.

<!--more-->


In addition to syndicating familiar indicators of COVID-19 activity, like cases and deaths, our COVIDcast [map](https://covidcast.cmu.edu/) and [API](https://cmu-delphi.github.io/delphi-epidata/api/covidcast.html) feature several novel early indicators. In past posts, we discussed our massive symptom surveys that have reached over ___ million people, in partnership with [Facebook](https://delphi.cmu.edu/blog/2020/08/26/covid-19-symptom-surveys-through-facebook/) and [Google](https://delphi.cmu.edu/blog/2020/09/18/covid-19-symptom-surveys-through-google/). Another of our significant data initiatives has been to forge partnerships with healthcare systems, granting us access to hospital records and insurance claims data covering 10-15% of the United States population.  Our team processes these data, releasing aggregates that can serve as early indicators of COVID activity that may improve epidemiological forecasts and help policymakers make informed decisions. The new data allow us to calculate a signal that estimates levels of symptoms when available. We discuss what the new data reveals over our confirmed cases signal, how we calculate the %CLI signal, why this data appears less useful over time, and how this discovery leads to a simple adjustment.

### How is this data relevant to our research?
The outpatient insurance claims provided data for our "Doctor Visits (DV)" signal, which estimates the percentage of office visits due to COVID-like symptoms. We also formed a new partnership with Change Healthcare to receive their insurance claims data, which will allow us to derive a new COVIDcast signal separate from our current DV signal. Because Change Healthcare's data covers approximately 45% of the United States population, we are excited to see how their raw data will translate into our "Doctor Visits" signal.
 
Electronic health records are instrumental in providing epidemic information in near real-time. Patients may interact with healthcare systems days before testing (if at all) and several more days before receiving results reported as confirmed cases by a state's Department of Health. Tracking visit data allows our signal to function as an _early indicator_ of confirmed cases and, alternatively, an early indicator of deaths. Advance knowledge of spikes of COVID-like symptoms can enable early containment efforts to manage emerging outbreaks.
 
The value of this aggregate data becomes apparent when you consider problems with official case counts:
 
1.   **Limited testing capacity:** limited testing capacity means that people saw a doctor for COVID-like symptoms and never received a test, even when they should have. Our data would represent this but exclude them from confirmed counts.
 
2.   **Reporting delays:** It can take several days between examination and testing, with a few more days between testing and results. If the test returns positive, health authorities report the results according to laws with additional verification and analysis (i.e., determining age and demographics) before adding the case to their public data. As a result, reports of confirmed cases are several weeks behind the medical examination date. Even with built-in delays (see below), amassing a claims-based signal allows estimations within 3-4 days of doctor's visits.
 
3.   **Date accuracy:** Sites like JHU and USA Facts scrape and report confirmed cases based on the cases' publicly posted dates. The "number of new daily counts" (derived by successive subtraction from these reports) refers to the number of cases _published_ instead of those _lab-confirmed_ on that date. In comparison, insurance claims indicate the "date of service" typically closer to the testing date. With a gap of several weeks in confirmed public posting, the "date of service" data allows for timely reporting.
 
4.   **Retrospective revisions:** Some states have changed their definition of confirmed COVID-19 cases. States then add and report hundreds of past cases as "new" on the definition date change, often assigning wrong dates in the process. Typically, the data dumping leaves no way to determine the actual test date. Insurance claims are thus useful, as they are not revised.

### The _Doctor Visits_ (DV) Indicator        
 
The Doctor Visits indicator is based solely on insurance claims. We count the claims for a given geographic area and day that fall into five categories:
 
1. Total: All claims, whether or not related to COVID-19, are also known as _all-cause_claims.
 
2. Flu: ICD-10 primary code starting with J09, J10, or J11, a definitive diagnosis of flu.
 
3. COVID-like: ICD-10 primary code in {U07.1, U07.2, B97.29, J12.81, Z03.818, B34.2, J12.89}. Some of these codes correspond to a definitive diagnosis of COVID-19, while others indicate similar symptoms.
 
4. Flu-like: ICD-10 primary code of J22 (acute lower respiratory infection) or B34.9 (viral infection, unspecified).
 
5. Mixed: ICD-10 primary code of Z20.828 (suspected exposure to COVID-19) or J12.9 (viral pneumonia).


We estimate the percent of COVID-like illness (%CLI) as (COVID-like + Flu-like + Mixed - Flu) / Total. While the flu is symptomatically COVID-like, they are unrelated to coronaviruses. We subtract Flu counts to make the signal directly related to COVID-19. Our indicator is also available at four geographic levels: county, MSA, HRR, and state. Select [here](https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/doctor-visits.html) for more details.

We set the signal to track as far back as February 1, 2020, showing minimal daily changes across the country until mid-March. For privacy and data integrity, we do not report signals if visits total lower than 500 over seven days ending on that date. We produce daily estimates for about 2000 counties-- around two-thirds of US counties-- and account for over 90% of the US population. 

The two maps below explore the signal. The left heatmap represents the average DV signal for each state from April 15 to May 15. The right heatmap illustrates the average confirmed daily cases per 100,000 people using data from [USAFACTS] (https://usafacts.org/issues/coronavirus/)  within those dates. As shown, states with high cases tend to show high %CLI, and states with lower cases tend to have lower %CLI. 


```{r, message=FALSE, warning=FALSE, cache=TRUE, fig.width=9}
library(covidcast)
library(dplyr)
library(gridExtra)
library(ggplot2)
library(stringr)

# Fetch DV % CLI signal and USA-Facts confirmed case incidence proportion at
# the state level
start_day = "2020-04-15"
end_day = "2020-05-15"
df_dv = covidcast_signal("doctor-visits", "smoothed_adj_cli",
                         start_day, end_day, geo_type = "state")
df_in = covidcast_signal("usa-facts", "confirmed_7dav_incidence_prop",
                         start_day, end_day, geo_type = "state")

# For each state, average the signals over all available times
df_dv_avg = df_dv %>% group_by(geo_value) %>% summarize(value = mean(value))
df_in_avg = df_in %>% group_by(geo_value) %>% summarize(value = mean(value))

# Set a bunch of fields so that the data frames know how to plot themselves
df_dv_avg$time_value = df_in_avg$time_value = start_day
df_dv_avg$issue = df_in_avg$issue = start_day
attributes(df_dv_avg)$geo_type = attributes(df_in_avg)$geo_type = "state"
class(df_dv_avg) = c("covidcast_signal", class(df_dv_avg))
class(df_in_avg) = c("covidcast_signal", class(df_in_avg))

# Plot choropleth maps, using the covidcast plotting functionality
subtitle = paste("Averaged over", start_day, "to", end_day)
p1 = plot(df_dv_avg,
          title = "% COVID-like illness, DV signal",
          range = c(0, 20), choro_params = list(subtitle = subtitle))
p2 = plot(df_in_avg,
          title = "Daily new confirmed COVID-19 cases per 100k pop.",
          range = c(0, 30), choro_params = list(subtitle = subtitle))
grid.arrange(p1, p2, nrow = 1)
```

### Backfill

Medical insurance claim records present challenges not seen in survey data. Data is available at a significant and variable latency, referred to as _backfill_. Backfill prevents a reliable estimate for a date of service for four days. We revise the indicator value every day based on new claims. We typically receive about half of the total claims within seven days following a date or service.

Certain claim types have a longer latency than others. We found that more claims available on a given date usually increases the %CLI. Our early indicator estimates usually underestimate the final value due to longer latency for COVID-like claims. 

### Weekday Effects 

Another challenge is the weekday influence on %CLI. Total counts and COVID-like counts decrease on weekends, with total counts decreasing proportionally because doctor visits tend to focus on acute care. Total counts include visits related to non-acute issues, but almost all COVID-like counts are due to acute issues. If not corrected, the %CLI curve spikes on weekends, creating a “sawtooth” pattern that does not represent real changes in COVID-like illness within a location. 

We made a corrected signal that accounts for this effect. The formal mathematical description is available on our [API documentation] (https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/doctor-visits.html#day-of-week-adjustment). 
As you can see in the corrected result below, the smooth curve is a more reasonable depiction:

```{r, message=FALSE, warning=FALSE, cache=TRUE}
start_day = "2020-05-01"
end_day = "2020-08-01"

data_unadjusted <- covidcast_signal("doctor-visits", "smoothed_cli",
                                    start_day = start_day, end_day = end_day,
                                    geo_type = "state")
data_adjusted <- covidcast_signal("doctor-visits", "smoothed_adj_cli",
                                  start_day = start_day, end_day = end_day,
                                  geo_type="state")

data_unadjusted = data_unadjusted %>%
  select(geo_value, signal, time_value, value) %>%
  tidyr::pivot_wider(names_from=signal, values_from = value)

data_adjusted = data_adjusted %>%
  select(geo_value, signal, time_value, value) %>%
  tidyr::pivot_wider(names_from = signal, values_from = value)

cmb_df = inner_join(data_unadjusted, data_adjusted)

cmb_df$geo_value = str_to_upper(cmb_df$geo_value)
states_to_plot = c("AZ", "CA", "GA", "FL", "NJ", "NY", "PA", "TX", "WI")
ggplot(cmb_df %>% filter(geo_value %in% states_to_plot)) +
  geom_line(aes(x = time_value, y = smoothed_cli, color = "Unadjusted")) +
  geom_line(aes(x = time_value, y = smoothed_adj_cli, color = "Adjusted")) +
  facet_wrap(vars(geo_value)) +
  labs(x = "Time", y = "%CLI",
       title = "Doctor visit signal, with and without weekday adjustment, for nine states")
```

It is important to note that the correction does not smooth time-wise. Instead, we make a point-wise correction based on seven fitted parameters for the days of the week. 

### Evaluating the Indicator

We evaluate the DV indicator by measuring its correlation with cases. We measure this correlation across two axes: space and time. Let $c_{it}$ and $d_{it}$ be the confirmed COVID-19 rate and DV indicator respectively, at location $i$ and time $t$. The space-wise correlation of an individual location $i$ is the rank correlation of $c_{\cdot t}$ and $d_{\cdot t}$, and the time-wise correlation of a single day $t$ is the rank correlation of $c_{i \cdot}$ and $d_{i \cdot}$. We predict that when the DV indicator is high, cases match. 

We plotted the distribution of time-wise correlation for each country with at least 500 confirmed cases below. Most counties show high time-wise correlation values that indicate a likely high case incidence if the signal increased in a county. 


```{r, message=FALSE, warning=FALSE, cache=TRUE}
start_day = "2020-04-15"
end_day = "2020-10-01"

data_adjusted <- covidcast_signal("doctor-visits", "smoothed_adj_cli", start_day, end_day)
df_cases = covidcast_signal("usa-facts", "confirmed_7dav_incidence_prop", start_day, end_day)

case_num = 500
cumulative_case_df = covidcast_signal("usa-facts", "confirmed_cumulative_num",
                                      max(df_cases$time_value), 
                                      max(df_cases$time_value))
geo_values = cumulative_case_df %>%
  filter(value >= case_num) %>% pull(geo_value)

dv_cases_df = bind_rows(data_adjusted, df_cases) %>%
  filter(geo_value %in% geo_values) %>%
  select(geo_value, signal, time_value, value) %>%
  tidyr::pivot_wider(names_from = signal, values_from = value) %>%
  rename(cases = confirmed_7dav_incidence_prop, dv = smoothed_adj_cli) %>%
  filter(purrr::map_lgl(geo_value, function(fips) { substr(fips, 3, 5) != "000"})) %>%
  group_by(time_value) %>%
  ungroup()

df_space_cor =
  covidcast_cor(data_adjusted %>%
                  filter(geo_value %in% geo_values),
                df_cases %>%
                  filter(geo_value %in% geo_values),
                by = "time_value", method = "spearman")

df_time_cor =
  covidcast_cor(data_adjusted %>%
                  filter(geo_value %in% geo_values),
                df_cases %>%
                  filter(geo_value %in% geo_values),
                by = "geo_value", method = "spearman")

ggplot(df_time_cor) +
  geom_density(aes(x = value)) +
  labs(title = "Time-wise Correlation between DV signal and case incidence",
       subtitle = "Over all counties with at least 500 cumulative cases",
       x = "Correlation", y = "Density")
```

Small count locations usually have lower signal-to-noise ratio, which means their correlations are generally closer to zero. The average correlation increases substantially in counties with more than 2,000 confirmed COVID-19 cases. The resulting increase in correlation is due to the threshold increase. We see higher average time-wise correlation in counties with higher cumulative case counts, shown below. 


```{r, message=FALSE, warning=FALSE}
df_time_cor = df_time_cor %>%
  inner_join(cumulative_case_df %>%
               select(geo_value, value) %>%
               rename(cases = value))

tibble(thresholds = seq(500, 20000, by = 500)) %>%
  mutate(avg_corr = purrr::map_dbl(thresholds,
                                   function(t) {
                                     mean(df_time_cor %>% filter(cases >= t) %>% pull(value), na.rm=T)
                                   })) %>%
  ggplot() +
  geom_line(aes(x = thresholds, y = avg_corr)) +
  labs(x = "Confirmed Cases Threshold", y = "Correlation",
       title = "Average Time-wise Correlation between DV signal and case incidence",
       subtitle = "Over all counties with cumulative cases greater than given threshold, as of October 1")
```

In our space-wise correlation over time plot shown below, the correlation remains somewhat steady into mid-July. Yet, the end of July shows a beginning decrease. The space-wise correlation is nearly zero or meaningless by late August, meaning on a given day in April or May, a high DV signal was likely to have higher case incidence than a lower signal in a county. By August or September, a higher DV signal was no longer tied to a higher case incidence.

```{r, message=FALSE, warning=FALSE}
ggplot(df_space_cor) +
  geom_line(aes(x = time_value, y = value)) +
  labs(title = "Space-wise Correlation between DV signal and case incidence",
       subtitle = "Over all counties with at least 500 cumulative cases",
       x = "Date", y = "Correlation")
```

### Correlation Deterioration


We sent out to find the cause of the correlation deterioration and found that some areas in the country have a higher DV “baseline” than others. We plotted the average case incidence and average DV signal for each of the 10 HHS regions below. (To see which states are in those regions, [visit the U.S. Department of Health and Human Services (HHS) website](https://www.hhs.gov/about/agencies/iea/regional-offices/index.html)).



```{r, message=FALSE, warning=FALSE, cache=TRUE}
fips_to_hhs = function(fips) {
  st = as.integer(substr(fips,1,2))
  if (st %in% c(9,23,25,33,44,50)) {
    return(1)
  } else if (st %in% c(34,36,72,78)) {
    return(2)
  } else if (st %in% c(10,11,24,42,51,54)) {
    return(3)
  } else if (st %in% c(1,12,13,21,28,37,45,47)) {
    return(4)
  } else if (st %in% c(17,18,26,27,39,55)) {
    return(5)
  } else if (st %in% c(5,22,35,40,48)) {
    return(6)
  } else if (st %in% c(19,20,29,31)) {
    return(7)
  } else if (st %in% c(8,30,38,46,49,56)) {
    return(8)
  } else if (st %in% c(4,6,15,32,60,66,69)) {
    return(9)
  } else if (st %in% c(2,16,41,53)) {
    return(10)
  } else {
    return(0)
  }
}
dv_cases_df = dv_cases_df %>%
  mutate(hhs = purrr::map_dbl(geo_value, fips_to_hhs))

dv_cases_df = dv_cases_df %>%
  left_join(county_census %>%
              select(FIPS, POPESTIMATE2019) %>%
              rename(geo_value = FIPS, pop = POPESTIMATE2019))

dv_cases_df %>%
  group_by(time_value, hhs) %>%
  summarize(dv = sum(dv * pop) / sum(pop), cases = sum(cases * pop) / sum(pop)) %>%
  ungroup() %>%
  ggplot() +
  geom_line(aes(x = time_value, y = cases, group = hhs, color = as.factor(hhs))) +
  labs(title = "Mean Case Incidence by HHS Region",
       x = "Date", y = "Cases", color = "HHS")

dv_cases_df %>%
  group_by(time_value, hhs) %>%
  summarize(dv = sum(dv * pop / sum(pop), na.rm = TRUE),
            cases = sum(cases * pop / sum(pop), na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot() +
  geom_line(aes(x = time_value, y = dv, group = hhs, color = as.factor(hhs))) +
  labs(title = "Mean DV Signal by HHS Region",
       x = "Date", y = "Value", color = "HHS")
```

Looking closely at the behavior of HHS 2 (New Jersey and New York), we compared two curves in two ways:
When the case incidence is high (or low) compared to other days, is the DV signal high (or low)?
When the case incidence is high (or low) compared to other regions, is the DV signal in HHS 2 high (or low)? 
The first question addresses the time-wise correlation; the second asks about the space-wise correlation. 

The answer to the first question is mostly yes. Case incidence is steadily decreasing throughout April and May, flattening out by mid-June. The DV signal peaks later than case incidence but decreases in May and is almost flat by mid-June, revealing that time-wise correlation within HHS 2 is good. 

However, the second question answer reveals an issue with the DV signal, with case incidence higher than all HHS regions in May into June. By July, HHS 2 and HSS 1 (New England) report the lowest case incidence, which is not true with the DV signal. HHS 2 shows the highest DV signal throughout most of the period, even with the lowest incidence case. In these plots, we point out why the space-wise correlations decline in August: counties in HHS 2 tend to have low case incidence but high DV signals, driving the correlations down. 

We now identified the problem: a DV signal of say 5% might mean a low case incidence for a county in New York, but a high case incidence for a county in Oregon. With six months’ worth of history for both the DV signal and case incidence, we can correct the problem using the signal to predict incidences in location-specific methods. 

We use a simple linear regression model to fit the DV signal to case incidence in our case. We turn a signal into a sensor. Past work within the Delphi group created sensors from signals and developed “sensor fusion,” which combined multiple sensors into a single estimate. Its performance is indicative of what we achieve by implementing it today, looking forward. Though out of scope for this post, it may present a topic for future research. For a more in-depth understanding, see chapter 4 of [Farrow 2016](https://delphi.cmu.edu/~dfarrow/thesis.pdf) and [Jahja et al. 2019](https://papers.nips.cc/paper/9475-kalman-filter-sensor-fusion-and-constrained-regression-equivalences-and-insights).

```{r, message=FALSE, warning=FALSE, cache=TRUE}
dv_cases_df = dv_cases_df %>%
  group_by(geo_value) %>%
  mutate(coef_6wk =
           purrr::map(time_value,
                      function(d) {
                        mask = time_value %in% (d-seq(7,41))
                        tryCatch(lm(cases[mask] ~ dv[mask])[["coefficients"]],error=function(x){NA})})) %>%
  ungroup()

dv_cases_df = dv_cases_df %>%
  mutate(slope_6wk = purrr::map_dbl(coef_6wk, function(c) { tryCatch(c[[2]], error=function(x) {NA})})) %>%
  mutate(int_6wk = purrr::map_dbl(coef_6wk, function(c) { tryCatch(c[[1]], error=function(x) {NA})})) %>%
  select(-coef_6wk)

lm_dv_cases_df = dv_cases_df %>%
  group_by(geo_value) %>%
  summarize(b=tryCatch(lm(cases ~ dv)[["coefficients"]][[1]],error=function(x){NA}),
            m=tryCatch(lm(cases ~ dv)[["coefficients"]][[2]],error=function(x){NA})) %>%
  ungroup()

df_space_corrected_cor = covidcast_cor(
  dv_cases_df %>% mutate(value = dv*slope_6wk + int_6wk, issue=time_value),
  dv_cases_df %>% mutate(value = cases, issue=time_value),
  by="time_value",
  method="spearman"
)

inner_join(df_space_cor %>% rename(orig_cor = value),
           df_space_corrected_cor %>% rename(corrected_cor = value)) %>%
  ggplot() +
  geom_line(aes(time_value, orig_cor, color = "Original Signal")) +
  geom_line(aes(time_value, corrected_cor, color = "\"Real Time\" Correction")) +
  labs(x = "Date", y = "Correlation",
       title = "Space-wise Correlation of DV-Corrected and Case Incidence",
       subtitle = "Over all counties with at least 500 cumulative cases") +
  theme(legend.position = "bottom", legend.title = element_blank())
```

We see that turning the DV signal into a sensor improves the space-wise correlations in the graph above. Furthermore, the relatively constant correlation over time demonstrates that the data quality did not necessarily decrease as a simple linear correction stopped the deterioration. 

### Open Questions and Future Directions  
             
We are happy to see a location-specific correction significantly increases the space-wise correlation. The regression coefficients of the correction, fit using a sliding window, change considerably over time. We would like to look into the non-stationary relationship between the DV signal and case incidence to understand why it changes and why counties in HHS 2 have such a different relationship in the first place.

We would like to compare this data with other healthcare insurance providers, such as comparing Healthcare Change’s signal to our sample size, correlations, and behavior. Our partnership with Change Healthcare grants us access to data with more extensive coverage than our current data, making their signal more or less correlated with reported case incidences. Other insurance providers cover different populations with different rates. We expect that by combining datasets and covering more of the population, we could produce a more useful signal.

Our data set could be useful in forecasting, as doctor visits usually precede confirmed COVID cases and deaths. The DV signal feature can also help predict what the case incidence will be several weeks into the future for some forecasting models. 

### Related Posts

[Google Survey](https://delphi.cmu.edu/blog/2020/09/18/covid-19-symptom-surveys-through-google/)
[Facebook Survey](https://delphi.cmu.edu/blog/2020/08/26/covid-19-symptom-surveys-through-facebook/)
[Tracking Mask-wearing Data](https://delphi.cmu.edu/blog/2020/10/12/new-and-improved-covid-symptom-survey-tracks-testing-and-mask-wearing/)


**Acknowledgements.** *Maria Jahja contributed immensely to every stage of this project, from determining which ICD codes to use to the final implementation of the signal. Aaron Rumack devised the weekday correction and analyzed the performance of the DV signal. Roni Rosenfeld worked closely with our health service partner to get access to the data, and provided domain knowledge to ensure that the data was useful. Both Roni and Ryan Tibshirani provided helpful suggestions and insights along the way.*

---

*Aaron Rumack is a Ph.D. student in the Machine Learning Department, advised by Roni Rosenfeld. He has been a member of the Delphi group since 2017.*

*[Roni Rosenfeld](http://cs.cmu.edu/~roni) is a lead researcher in the Delphi group, and a Professor and Head of the Machine Learning Department at CMU. He is also a Google Fellow.*
